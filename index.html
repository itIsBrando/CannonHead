<!doctype html>
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta http-equiv="imagetoolbar" content="no" />
        <meta charset="UTF-8">
        <title>Cannonhead Clash</title>
        <!-- <h1>Cannonhead Clash</h1> -->
        <div id="canvasDiv">
            <canvas id="myCanvas" width="256" height="256" style="padding: 0; margin: auto; display: block;"></canvas>
        </div>
        <div id="gamepad" class="touchBtns">
            <span>
                <img src="images/sprite2.png" class="btns" width="64" height="64" onpointerdown="javascript:startMove(-1)" onpointerup="javascript:stopMove()"><img />
                <img src="images/sprite2.png" class="btns" width="64" height="64" onpointerdown="javascript:startMove(1)" onpointerup="javascript:stopMove()"><img />
                <img src="images/sprite2.png" class="btns" style="padding-left: 100px;" width="32" height="32" onpointerdown="javascript:startCharge()" onpointerup="javascript:stopCharge()"> <img />
            </span>
        </div>
        <style>
            :root {
                image-rendering: crisp-edges;
                image-rendering: optimizeSpeed; 
                image-rendering: pixelated;
                image-rendering: optimizeContrast;
                -ms-interpolation-mode: nearest-neighbor;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }

            html, body {
                padding: 0px;
                width: 100%;
                height: 100%;
                margin: 0px;
                border: 0px;
                /* overflow: hidden; */
                display: block;
                background-color: ivory;
                -webkit-touch-callout: none; /* prevent selecting */
            }

            #canvas {
                position: absolute;
            }

            .btns {
                display: inline-block;
                padding: 0px 0px 0px 0px;
                padding-right: 0px;
                padding-left: 0px;
                cursor: pointer;
            }


            .touchBtns {
                text-align: center;
                z-index: 15;
                max-height: 90%;
                bottom: 0%;
                position: absolute;
            }
        </style>
        <br>
        <div id="preGameDiv">
            <p id="myIDBody">Game ID:</p>
            <a id="joinLink" target="_blank">Use this link to join your game.</a>
            <tr> <td>
                <form name="Friend ID" id="myIDForm">
                    <input type="text" id="IDInput"/>
                </form>
            </td> </tr>
            <tr> <td>
                <input type="button" name="start" value="Start" onclick="Game.run(true)"> </label>
            </td> </tr>
            <input type="checkbox" onclick="">
            <label for="vehicle1">dark</label><br>
        </div>
        <div id="joinByLinkDiv" value="Join this game." onclick="javascript:joinByLink()">
            <input type="button", 
        </div>
        <img style="display: none" id="sprite1" src="images/sprite1.png" crossorigin="anonymous" />
        <img style="display: none" id="sprite2" src="images/sprite2.png" crossorigin="anonymous" />
        <script src="javascript/player.js"></script>
        <script src="javascript/game.js"></script>
        <script src="javascript/bomb.js"></script>
        <script src="javascript/peer.js"></script>
        <script type="text/javascript">
            var xScale;
            var yScale;
            var counter = [];
            let gamepad = document.getElementById("gamepad");

            function hasTouchScreen() {
                return window.location.href.indexOf("?touch") !== -1 ||window.location.href.indexOf("&touch") !== -1 || navigator.userAgent.match(/Android/i) || navigator.userAgent.match(/webOS/i) || navigator.userAgent.match(/iPhone/i) || navigator.userAgent.match(/iPad/i) || navigator.userAgent.match(/iPod/i) || navigator.userAgent.match(/BlackBerry/i) || navigator.userAgent.match(/Windows Phone/i)
            }

            function startMove(dx) {
                counter.push(setInterval(() => {
                    players[gameState.me].move(dx);    
                }, 50));
            }

            function stopMove() {
                counter.forEach(c => {
                    clearInterval(c);
                });
                counter.splice(0, counter.length);
            }

            function startCharge() {
                counter.push(setInterval(() => {
                    players[gameState.me].charge();    
                }, 50));
                
            }

            function stopCharge() {
                stopMove();
                players[gameState.me].fire();
            }

            if(hasTouchScreen()) {
                window.TOUCH = true;
                console.log("has touchscreen");
                // prevent zooming when tapping buttons
            } else {
                // window.TOUCH = true;
                gamepad.style.display = "none";
            }
            
            gamepad.addEventListener("click", event =>{});

            function getUrlVars() {
                var vars = {};
                var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                    vars[key] = value;
                });
                return vars;
            }

            function keyCodeFromEvent(event) {
                if(window.event) { // IE                    
                    return event.keyCode;
                } else if(event.which) { // Netscape/Firefox/Opera                   
                    return event.which;
                }
            }


            document.onkeyup = function(event) {
                let key = keyCodeFromEvent(event);
                let char = String.fromCharCode(key).toLowerCase();

                switch(char) {
                    case 'q':
                        players[gameState.me].fire();
                        break;
                }
            }


            document.onkeypress = function(event) {
                let key = keyCodeFromEvent(event);
                let char = String.fromCharCode(key);

                if(key == 13)
                {
                    return;
                }
                
                if(!inGame) {
                    return;
                }
                
                switch(char) {
                    case 'a':
                        players[gameState.me].move(-1);
                        break;
                    case 'd':
                        players[gameState.me].move(1);
                        break;
                    case 'q':
                        players[gameState.me].charge();
                        break;
                }
            }

            // change scaling
            function initializeScaling() {
                let w = Math.floor(window.innerWidth/128);
                let h = Math.floor(window.innerHeight/128);
                xScale = yScale = Math.min(w, h);
                context.canvas.width = window.innerWidth; //128 * xScale;
                context.canvas.height = window.innerHeight;//128 * yScale;
    
                context.scale(xScale, yScale);

                sprites[0].width = sprites[1].width = 8 * xScale;
                sprites[0].height = sprites[1].height = 8 * yScale;

                if(inGame) {
                    game.fullRedraw();
                }
            }

        </script>
        <script type="text/javascript">
            var peer = new Peer();
            var gameState = new GameState();
            var canvas = document.getElementById("myCanvas");
            var context = canvas.getContext("2d");
            let players = [];
            var inGame = false;
            var peerID = '', myID = '';

            initializeScaling();
            window.onresize = initializeScaling;

            context.fillStyle = "#000000";
            context.fillRect(0, 0, 128, 128);
            // disable pixel smoothing
            context.imageSmoothingEnabled = false;

            document.getElementById("canvasDiv").style.display="none"

            Player.add();

            // get our custom ID and display it
            peer.on('open', function(id) {
                myID = id.toString();
                document.getElementById("myIDBody").textContent += id.toString();
                document.getElementById("joinLink").href = "http://paradise.home/local/bk/?c=" + myID;
            });
            
            peerSetGuest();

            function joinByLink() {
                document.getElementById("joinByLinkDiv").style.display = "none";
                Game.run(true);
                
            }
            
            // parse URL data
            let friendCode = getUrlVars()['c'];
            console.log("url para:" + friendCode);
            if(friendCode != undefined) {
                peer.on('open', function(id) {
                    myID = id.toString();
                });
                
                document.getElementById("IDInput").value = friendCode;
                document.getElementById("preGameDiv").style.display = "none";
                document.getElementById("joinByLinkDiv").style.display = "block";
            }

        </script>
</head>