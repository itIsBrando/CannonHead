<!doctype html>
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Cannonhead Clash</title>
        <div id="canvasDiv">
            <canvas id="myCanvas" width="256" height="256"></canvas>
        </div>
        <br>
        <div id="preGameDiv">
            <p id="myIDBody">Give this to your friend:  </p>
            <tr> <td>
                <form name="Friend ID" id="myIDForm">
                    <input type="text" id="IDInput"/>
                </form>
            </td> </tr>
            <tr> <td>
                <input type="button" name="start" value="Start" onclick="Game.run(true)"> </label>
            </td> </tr>
        </div>
        <img style="display: none" id="sprite1" src="sprite1.png" crossorigin="anonymous" />
        <script src="player.js"></script>
        <script src="game.js"></script>
        <script src="bomb.js"></script>
        <script type="text/javascript">
            var xScale;
            var yScale;

            function getUrlVars() {
                var vars = {};
                var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                    vars[key] = value;
                });
                return vars;
            }

            function keyCodeFromEvent(event) {
                if(window.event) { // IE                    
                    return event.keyCode;
                } else if(event.which) { // Netscape/Firefox/Opera                   
                    return event.which;
                }
            }


            document.onkeyup = function(event) {
                let key = keyCodeFromEvent(event);
                let char = String.fromCharCode(key).toLowerCase();

                switch(char) {
                    case 'q':
                        players[0].fire();
                        break;
                }
            }


            document.onkeypress = function(event) {
                let key = keyCodeFromEvent(event);
                let char = String.fromCharCode(key);

                if(key == 13)
                {
                    return;
                }
                
                if(!inGame) {
                    return;
                }
                console.log(char);
                
                switch(char) {
                    case 'a':
                        players[0].move(-1);
                        break;
                    case 'd':
                        players[0].move(1);
                        break;
                    case 'q':
                        players[0].charge();
                        break;
                }
            }

            // change scaling
            function initializeScaling() {
                let w = Math.floor(window.innerWidth/128);
                let h = Math.floor(window.innerHeight/128);
                xScale = yScale = Math.min(w, h);
                canvas.width = 128 * xScale;
                canvas.height = 128 * yScale;
    
                context.scale(xScale, yScale);
            }

        </script>
        <script type="text/javascript">
            var peer = new Peer();
            var canvas = document.getElementById("myCanvas");
            var context = canvas.getContext("2d");
            let players = [];
            var inGame = false;
            var peerID = ''

            initializeScaling();
            window.onresize = initializeScaling;

            context.fillStyle = "#000000";
            context.fillRect(0, 0, 128, 128);

            Player.add();
            // get our custom ID and display it
            peer.on('open', function(id) {
                document.getElementById("myIDBody").textContent += id.toString() + "<br /> or send them this link: https://itisbrando.github.io/CannonHead/?c=" + id.toString();
            });
            
            // when guest
            peer.on('connection', function(connection) {
                connection.on('data', function(data) {
                    console.log(data);
                    Player.add();
                    Game.run(false);
                });
            });

            // parse URL data
            let friendCode = getUrlVars()['code'];
            console.log("url para:" + friendCode);
            if(friendCode != undefined) {
                document.getElementById("IDInput").value = friendCode;
                Game.run();
            }

        </script>
</head>